// Parse adjacency matrix JSON
function parseAdjMatrix(input) {
  try {
    const matrix = JSON.parse(input);
    if (!Array.isArray(matrix)) throw new Error();
    return matrix;
  } catch {
    alert("❌ Invalid matrix format! Example: [[0,1],[1,0]]");
    return null;
  }
}

// DFS Implementation
function dfs(matrix, start) {
  const visited = [];
  const stack = [start];

  while (stack.length > 0) {
    const node = stack.pop();
    if (!visited.includes(node)) {
      visited.push(node);

      for (let n = matrix[node].length - 1; n >= 0; n--) {
        if (matrix[node][n] === 1 && !visited.includes(n)) {
          stack.push(n);
        }
      }
    }
  }
  return visited;
}

// Graph visualization
function visualizeGraph(matrix, order) {
  const container = document.getElementById("graphContainer");
  container.innerHTML = "";

  const width = container.clientWidth - 80;
  const height = container.clientHeight - 80;

  const nodes = matrix.map((_, i) => ({
    id: i,
    x: Math.random() * width + 40,
    y: Math.random() * height + 40
  }));

  // Draw edges
  matrix.forEach((row, i) => {
    row.forEach((connected, j) => {
      if (connected && i < j) {
        const edge = document.createElement("div");
        edge.className = "edge";

        const x1 = nodes[i].x;
        const y1 = nodes[i].y;
        const x2 = nodes[j].x;
        const y2 = nodes[j].y;

        const length = Math.hypot(x2 - x1, y2 - y1);
        const angle = (Math.atan2(y2 - y1, x2 - x1) * 180) / Math.PI;

        edge.style.width = `${length}px`;
        edge.style.left = `${x1}px`;
        edge.style.top = `${y1}px`;
        edge.style.transform = `rotate(${angle}deg)`;

        container.appendChild(edge);
      }
    });
  });

  // Draw nodes
  nodes.forEach((n) => {
    const node = document.createElement("div");
    node.className = "node";
    node.innerText = n.id;
    node.style.left = `${n.x - 16}px`;
    node.style.top = `${n.y - 16}px`;
    container.appendChild(node);
  });

  // Animate DFS traversal
  let i = 0;
  const interval = setInterval(() => {
    if (i >= order.length) return clearInterval(interval);

    const id = order[i];
    const nodeElements = document.getElementsByClassName("node");

    for (let el of nodeElements) {
      if (parseInt(el.innerText) === id) {
        el.style.backgroundColor = "#e74c3c";
        el.style.transform = "scale(1.15)";
      }
    }

    i++;
  }, 600);
}

// Events
document.getElementById("runBtn").addEventListener("click", () => {
  const matrix = parseAdjMatrix(adjMatrix.value);
  if (!matrix) return;

  const start = parseInt(startNode.value);
  if (isNaN(start) || start < 0 || start >= matrix.length) {
    alert("❌ Invalid start node");
    return;
  }

  const result = dfs(matrix, start);
  visitedNodes.innerText = result.join(", ");
});

document.getElementById("visualizeBtn").addEventListener("click", () => {
  const matrix = parseAdjMatrix(adjMatrix.value);
  if (!matrix) return;

  const start = parseInt(startNode.value);
  const order = dfs(matrix, start);

  visualizeGraph(matrix, order);
});
